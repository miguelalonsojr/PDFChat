<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFChat - Local PDF Q&A</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Solarized Dark Color Palette */
        :root {
            --base03: #002b36;
            --base02: #073642;
            --base01: #586e75;
            --base00: #657b83;
            --base0: #839496;
            --base1: #93a1a1;
            --base2: #eee8d5;
            --base3: #fdf6e3;
            --yellow: #b58900;
            --orange: #cb4b16;
            --red: #dc322f;
            --magenta: #d33682;
            --violet: #6c71c4;
            --blue: #268bd2;
            --cyan: #2aa198;
            --green: #859900;
        }

        [x-cloak] { display: none !important; }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            background-color: var(--base03);
            color: var(--base0);
            display: flex;
            flex-direction: column;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .header-section {
            flex-shrink: 0;
            padding: 1rem;
        }

        .chat-section {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 2rem;
            background-color: var(--base02);
        }

        .input-section {
            flex-shrink: 0;
            padding: 1rem;
            background-color: var(--base02);
            border-top: 1px solid var(--base01);
        }

        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chat-section::-webkit-scrollbar {
            width: 8px;
        }

        .chat-section::-webkit-scrollbar-track {
            background: var(--base03);
        }

        .chat-section::-webkit-scrollbar-thumb {
            background: var(--base01);
            border-radius: 4px;
        }

        .chat-section::-webkit-scrollbar-thumb:hover {
            background: var(--base00);
        }

        .card {
            background-color: var(--base02);
            border: 1px solid var(--base01);
        }

        .header-title {
            color: var(--base1);
        }

        .header-subtitle {
            color: var(--base0);
        }

        .user-message {
            background-color: var(--blue);
            color: var(--base03);
        }

        .assistant-message {
            background-color: var(--base01);
            color: var(--base1);
        }

        .loading-bubble {
            background-color: var(--base01);
        }

        .loading-dot {
            background-color: var(--cyan);
        }

        .input-field {
            background-color: var(--base02);
            border: 1px solid var(--base01);
            color: var(--base1);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--cyan);
            box-shadow: 0 0 0 2px rgba(42, 161, 152, 0.2);
        }

        .input-field:disabled {
            background-color: var(--base03);
            color: var(--base00);
        }

        .input-field::placeholder {
            color: var(--base00);
        }

        .btn-primary {
            background-color: var(--cyan);
            color: var(--base03);
            font-weight: 500;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--green);
        }

        .btn-primary:disabled {
            background-color: var(--base01);
            color: var(--base00);
            cursor: not-allowed;
        }

        .btn-reset {
            color: var(--base0);
        }

        .btn-reset:hover:not(:disabled) {
            color: var(--cyan);
        }

        .btn-reset:disabled {
            color: var(--base01);
        }

        .error-message {
            background-color: var(--base02);
            border: 1px solid var(--red);
            color: var(--red);
        }

        .empty-state-icon {
            color: var(--base01);
        }

        .empty-state-text {
            color: var(--base0);
        }

        .divider {
            border-color: var(--base01);
        }
    </style>
</head>
<body>
    <div x-data="chatApp()" x-cloak class="app-container">
        <!-- Header Section (Sticky Top) -->
        <div class="header-section">
            <div class="card rounded-lg shadow-md p-6">
                <h1 class="text-3xl font-bold header-title mb-2">PDFChat</h1>
                <p class="header-subtitle">Ask questions about your PDF documents</p>
            </div>
        </div>

        <!-- Chat Section (Scrollable Middle) -->
        <div class="chat-section space-y-4" x-ref="chatContainer">
                <template x-if="messages.length === 0">
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 empty-state-icon mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <p class="text-lg empty-state-text">Start a conversation about your documents</p>
                    </div>
                </template>

                <template x-for="(msg, index) in messages" :key="index">
                    <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                        <div :class="msg.role === 'user'
                            ? 'user-message rounded-lg px-4 py-2 max-w-xl'
                            : 'assistant-message rounded-lg px-4 py-2 max-w-xl'">
                            <div class="message-content" x-text="msg.content"></div>
                        </div>
                    </div>
                </template>

                <!-- Loading indicator -->
                <template x-if="isLoading">
                    <div class="flex justify-start">
                        <div class="loading-bubble rounded-lg px-4 py-2">
                            <div class="flex space-x-2">
                                <div class="w-2 h-2 loading-dot rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 loading-dot rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 loading-dot rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </template>
        </div>

        <!-- Input Section (Sticky Bottom) -->
        <div class="input-section">
            <form @submit.prevent="sendMessage()" class="flex space-x-2">
                <input
                    type="text"
                    x-model="currentMessage"
                    :disabled="isLoading"
                    placeholder="Ask a question about your PDFs..."
                    class="flex-1 input-field rounded-lg px-4 py-2"
                >
                <button
                    type="submit"
                    :disabled="isLoading || !currentMessage.trim()"
                    class="btn-primary px-6 py-2 rounded-lg transition-colors"
                >
                    Send
                </button>
            </form>

            <!-- Reset button and error messages -->
            <div class="mt-2 flex justify-between items-center">
                <div x-show="error" class="error-message px-4 py-2 rounded-lg flex-1 mr-2">
                    <p x-text="error" class="text-sm"></p>
                </div>
                <button
                    @click="resetChat()"
                    :disabled="isLoading"
                    class="text-sm btn-reset whitespace-nowrap"
                >
                    Reset conversation
                </button>
            </div>
        </div>
    </div>

    <script>
        function chatApp() {
            return {
                messages: [],
                currentMessage: '',
                isLoading: false,
                error: '',

                async sendMessage() {
                    if (!this.currentMessage.trim() || this.isLoading) return;

                    const userMessage = this.currentMessage.trim();
                    this.currentMessage = '';
                    this.error = '';

                    // Add user message
                    this.messages.push({
                        role: 'user',
                        content: userMessage
                    });

                    this.scrollToBottom();
                    this.isLoading = true;

                    try {
                        // Call streaming API
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ message: userMessage })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Read streaming response
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        // Add assistant message placeholder
                        this.messages.push({
                            role: 'assistant',
                            content: ''
                        });

                        const assistantMessageIndex = this.messages.length - 1;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            this.messages[assistantMessageIndex].content += chunk;
                            this.scrollToBottom();
                        }

                    } catch (err) {
                        this.error = `Error: ${err.message}. Make sure the server is running and the index is built.`;
                        console.error('Error:', err);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async resetChat() {
                    if (!confirm('Are you sure you want to reset the conversation?')) return;

                    try {
                        const response = await fetch('/api/reset', {
                            method: 'POST'
                        });

                        if (response.ok) {
                            this.messages = [];
                            this.error = '';
                        }
                    } catch (err) {
                        this.error = `Error resetting chat: ${err.message}`;
                    }
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.chatContainer;
                        container.scrollTop = container.scrollHeight;
                    });
                }
            }
        }
    </script>
</body>
</html>
